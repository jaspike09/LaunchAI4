<script>
const SUPABASE_URL = 'https://yvgzyymjymrgjhhthgtj.supabase.co';
const SUPABASE_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Inl2Z3p5eW1qeW1yZ2poaHRoZ3RqIiwicm9sZSI6ImFub24iLCJpYXQiOjE3Njk5OTc1MzIsImV4cCI6MjA4NTU3MzUzMn0.814FVde267XILaw-VA76Yuk6Y6BVQpCr_5fAF2KtBFw'; 

const _supabase = supabase.createClient(SUPABASE_URL, SUPABASE_KEY);

let currentProfile = null;
let currentAgent = "MentorAI";

// 1. INITIALIZE HQ
async function init() {
    try {
        const { data: { session }, error: authError } = await _supabase.auth.getSession();
        if (!session || authError) {
            window.location.href = 'auth.html';
            return;
        }

        document.getElementById('userNameDisplay').innerText = session.user.email.split('@')[0];

        const { data: profile } = await _supabase
            .from('profiles')
            .select('*')
            .eq('id', session.user.id)
            .maybeSingle();

        if (profile) {
            currentProfile = profile;
            document.getElementById('ideaDisplay').innerText = `"${profile.business_idea}"`;
            document.getElementById('auditScoreDisplay').innerText = profile.last_audit_score || "--";
            
            const scoreEl = document.getElementById('auditScoreDisplay');
            scoreEl.classList.remove('score-glow-red', 'score-glow-green');
            scoreEl.classList.add(profile.last_audit_score < 55 ? 'score-glow-red' : 'score-glow-green');

            if (!profile.has_seen_briefing) {
                handleBriefing(profile, session.user);
            }
        }

        updateProgressUI(session.user.id);
        fetchDailyIdea();

    } catch (err) {
        console.error("Critical HQ Failure:", err);
    }
}

// 2. MENTOR BRIEFING LOGIC
async function handleBriefing(profile, user) {
    const overlay = document.getElementById('briefingOverlay');
    const video = document.getElementById('demoVideo');
    const closeBtn = document.getElementById('closeBriefing');

    overlay.classList.remove('hidden');
    
    const assignmentText = (profile.last_audit_score || 0) < 50 
        ? "Pivot your business model to lower overhead." 
        : "Begin your Market Deep Dive with MarketingAI.";

    setTimeout(() => {
        video.play().catch(e => console.warn("Autoplay blocked"));
        updateSubtitles("To speak with the GEMS Board members, there are a couple things we must complete!", 4000);
        
        setTimeout(() => {
            updateSubtitles(`Since your vision is focused on "${profile.business_idea || 'this venture'}"...`, 4000);
            
            setTimeout(() => {
                updateSubtitles(`Your first priority: ${assignmentText}`, 5000);
            }, 4500);
        }, 4500);
    }, 1000);

    video.onended = () => {
        closeBtn.classList.remove('hidden');
        updateSubtitles("Dismiss this briefing to begin your assignments.", 3000);
    };

    closeBtn.onclick = async () => {
        overlay.classList.add('opacity-0');
        await _supabase.from('profiles').update({ has_seen_briefing: true }).eq('id', user.id);
        setTimeout(() => overlay.remove(), 500);
    };
}

function updateSubtitles(text, duration) {
    const el = document.getElementById('mentorSubtitles');
    if (!el) return;
    el.innerText = text;
    el.classList.add('animate-pulse');
    setTimeout(() => {
        if(el.innerText === text) el.innerText = "";
        el.classList.remove('animate-pulse');
    }, duration);
}

// 3. CHAT & GEMS BOARD LOGIC
async function sendMessage() {
    const input = document.getElementById('chatInput');
    const chatBox = document.getElementById('chatBox');
    const text = input.value.trim();
    if (!text) return;

    chatBox.innerHTML += `<div class="flex justify-end mb-4"><div class="bg-blue-600/20 p-4 rounded-2xl border border-blue-500/30 max-w-[85%] text-sm">${text}</div></div>`;
    input.value = "";
    
    const aiId = 'ai-' + Date.now();
    chatBox.innerHTML += `<div class="flex justify-start mb-4"><div class="glass-panel p-4 rounded-2xl border border-white/10 max-w-[85%] text-sm"><b class="text-blue-400 block mb-1 text-[10px] uppercase tracking-widest">${currentAgent}</b><span id="${aiId}">...</span></div></div>`;
    chatBox.scrollTop = chatBox.scrollHeight;

    try {
        const response = await fetch('/api/architect', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ 
                messages: [{ role: 'user', content: text }],
                agent: currentAgent,
                idea: currentProfile?.business_idea,
                capital: currentProfile?.capital || "0",
                hours: currentProfile?.focus_hours || "4"
            })
        });

        const reader = response.body.getReader();
        const decoder = new TextDecoder();
        const textTarget = document.getElementById(aiId);
        textTarget.innerText = "";

        while (true) {
            const { done, value } = await reader.read();
            if (done) break;
            
            const chunk = decoder.decode(value);
            const lines = chunk.split('\n');
            
            for (const line of lines) {
                if (line.startsWith('data: ')) {
                    const dataStr = line.replace('data: ', '');
                    if (dataStr === '[DONE]') break;
                    try {
                        const json = JSON.parse(dataStr);
                        textTarget.innerText += json.choices[0]?.delta?.content || "";
                    } catch (e) {}
                } else if (line.trim().length > 0 && !line.startsWith('data:')) {
                    textTarget.innerText += line;
                }
            }
            chatBox.scrollTop = chatBox.scrollHeight;
        }
    } catch (e) { document.getElementById(aiId).innerText = "Uplink Terminated."; }
}

// 4. NAVIGATION
function showSection(id) {
    document.getElementById('overview').classList.toggle('hidden', id !== 'overview');
    document.getElementById('chatArea').classList.toggle('hidden', id !== 'chatArea');
    document.querySelectorAll('.sidebar-link').forEach(l => l.classList.remove('active-link'));
    if(id === 'overview') document.getElementById('link-overview').classList.add('active-link');
}

function openChat(agent) {
    currentAgent = agent;
    showSection('chatArea');
    document.getElementById('sectionTitle').innerText = agent;
    document.getElementById('chatBox').innerHTML = `<div class="text-[10px] text-center text-slate-500 uppercase tracking-[0.2em] my-4">Secure Line: ${agent}</div>`;
}

async function logout() {
    await _supabase.auth.signOut();
    window.location.href = 'index.html';
}

init();
</script>
